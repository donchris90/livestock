{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <h2>üì¶ Order Details</h2>

    <div class="card mb-3">
        <div class="card-header">
            Product: {{ order.product.title }}
        </div>
        <div class="card-body">

            {# --- Status Badge with Tooltip & Icon --- #}
            <p><strong>Status:</strong>
                {% set status = order.status.name %}
                <span class="badge
                    {% if status == 'PENDING' %}bg-warning text-dark
                    {% elif status == 'ACCEPTED' %}bg-primary text-white
                    {% elif status == 'PAID' %}bg-success text-white
                    {% elif status == 'SHIPPED' %}bg-info text-white
                    {% elif status == 'COMPLETED' %}bg-dark text-white
                    {% elif status == 'CANCELED' %}bg-danger text-white
                    {% else %}bg-secondary text-white
                    {% endif %}"
                      data-bs-toggle="tooltip" title="Order is {{ order.status.value }}">
                    {% if status == 'PENDING' %}‚è≥
                    {% elif status == 'ACCEPTED' %}‚úîÔ∏è
                    {% elif status == 'PAID' %}üí∞
                    {% elif status == 'SHIPPED' %}üöö
                    {% elif status == 'COMPLETED' %}üèÅ
                    {% elif status == 'CANCELED' %}‚ùå
                    {% endif %}
                    {{ order.status.value }}
                </span>

                {# --- Escrow Badge with Icon & Tooltip --- #}
                {% if current_user.id == order.buyer_id %}
                    {% for e in order.product.escrows %}
                        {% if e.buyer_id == current_user.id and not e.is_paid %}
                            <span class="badge bg-warning text-dark" data-bs-toggle="tooltip" title="Your escrow payment is pending">
                                üîí Pending Escrow
                            </span>
                        {% endif %}
                    {% endfor %}
                {% elif current_user.id == order.seller_id %}
                    {% for e in order.product.escrows %}
                        {% if e.is_paid %}
                            <span class="badge bg-success text-dark" data-bs-toggle="tooltip" title="Escrow payment received">
                                üíµ Escrow Received
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </p>

            <p><strong>Agreed Price:</strong> ‚Ç¶{{ order.agreed_price or "N/A" }}</p>
            <p><strong>Created:</strong> {{ order.created_at.strftime('%b %d, %Y') }}</p>

            <hr>
            <h5>üë§ Parties</h5>
            <p><strong>Buyer:</strong> {{ order.buyer.full_name }} ({{ order.buyer.phone }})</p>
            <p><strong>Seller:</strong> {{ order.seller.full_name }} ({{ order.seller.phone }})</p>

            {% if order.agent_id %}
            <p><strong>Agent:</strong> {{ order.agent.full_name }} ({{ order.agent.phone }})</p>
            {% endif %}

            <hr>
            <a href="{{ url_for('chat.chat_with_user', receiver_id=(order.seller.id if current_user.id == order.buyer_id else order.buyer.id)) }}" class="btn btn-success">üí¨ Chat Now</a>
            <a href="https://wa.me/{{ order.seller.phone if current_user.id == order.buyer_id else order.buyer.phone }}" class="btn btn-outline-success" target="_blank">üì± WhatsApp</a>
            {% if order.agent_id %}
            <a href="{{ url_for('view_agent', agent_id=order.agent.id) }}" class="btn btn-outline-primary">üïµÔ∏è View Agent</a>
            {% endif %}

            <hr>
            {# Show Escrow button only if buyer has not paid/completed escrow #}
            {% if current_user.id == order.buyer_id %}
                {% set show_escrow = true %}
                {% for e in order.product.escrows %}
                    {% if e.buyer_id == current_user.id and e.is_paid %}
                        {% set show_escrow = false %}
                    {% endif %}
                {% endfor %}
                {% if show_escrow and order.status.name not in ['PAID','COMPLETED'] %}
                    <a href="{{ url_for('escrow.escrow_offer', product_id=order.product.id) }}" class="btn btn-warning mb-3">
                        üí∞ Use Escrow
                    </a>
                {% endif %}
            {% endif %}

            <hr>
            {# Action buttons #}
            {% for action in actions %}
            <form method="POST" action="{{ url_for('seller_dashboard.handle_order_action', order_id=order.id, action=action) }}" class="d-inline">
                <button type="submit" class="btn btn-outline-primary">
                    {% if action == "accepted" %}Accept
                    {% elif action == "canceled" %}Cancel
                    {% elif action == "shipped" %}Mark as Shipped
                    {% elif action == "completed" %}Mark as Completed
                    {% elif action == "paid" %}Mark as Paid
                    {% endif %}
                </button>
            </form>
            {% endfor %}

            {% if current_user.id == order.buyer_id and order.status.name == "completed" %}
  {% if not order.reviews %}
    <form method="POST" action="{{ url_for('seller_dashboard.add_order_review', order_id=order.id) }}">
      <label for="rating">Rating:</label>
      <select name="rating" required>
        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
        <option value="3">‚≠ê‚≠ê‚≠ê</option>
        <option value="2">‚≠ê‚≠ê</option>
        <option value="1">‚≠ê</option>
      </select>
      <textarea name="comment" class="form-control mt-2" placeholder="Write your review..." required></textarea>
      <button type="submit" class="btn btn-success mt-2">Submit Review</button>
    </form>
  {% else %}
    <p class="text-muted">You already reviewed this order.</p>
  {% endif %}
{% endif %}

        </div>
    </div>

    <a href="{{ url_for('seller_dashboard.my_orders') }}" class="btn btn-secondary">‚Üê Back to Orders</a>
</div>

{# --- Initialize Bootstrap Tooltips --- #}
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">

            <!-- Existing Accounts -->
            {% if bank_accounts %}
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-header bg-light">
                    <strong>ðŸ’¼ Saved Bank Accounts</strong>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Bank</th>
                                <th>Account Number</th>
                                <th>Account Name</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bank in bank_accounts %}
                            <tr>
                                <td>{{ bank.bank_name }}</td>
                                <td>{{ bank.account_number }}</td>
                                <td>{{ bank.account_name }}</td>
                                <td>
                                    <form method="POST" action="{{ url_for('seller_dashboard.delete_bank_account', account_id=bank.id) }}" onsubmit="return confirm('Delete this account?');">
                                        {{ form.hidden_tag() }}
                                        <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Add New Account Form -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white text-center">
                    <h5 class="mb-0">âž• Add New Bank Account</h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('seller_dashboard.setup_payout') }}">
                        {{ form.hidden_tag() }}

                        <div class="mb-3">
                            <label for="bank_name" class="form-label fw-semibold">Bank</label>
                            {{ form.bank_name(class="form-select", id="bank_name") }}
                        </div>

                        <div class="mb-3">
                            <label for="account_number" class="form-label fw-semibold">Account Number</label>
                            {{ form.account_number(class="form-control", id="account_number", placeholder="10-digit account number") }}
                        </div>

                        <div class="mb-3">
                            <label for="account_name" class="form-label fw-semibold">Account Name</label>
                            {{ form.account_name(class="form-control", id="account_name", readonly=True, placeholder="Auto-filled") }}
                        </div>

                        <div class="d-grid mt-3">
                            {{ form.submit(class="btn btn-success btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
document.getElementById("account_number").addEventListener("blur", function () {
    const accountNumber = this.value.trim();
    const bankCode = document.getElementById("bank_name").value;

    if (accountNumber.length === 10 && bankCode) {
        fetch("{{ url_for('seller_dashboard.resolve_account') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ account_number: accountNumber, bank_code: bankCode })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById("account_name").value = data.account_name;
            } else {
                alert("Failed to resolve account: " + (data.message || ""));
                document.getElementById("account_name").value = "";
            }
        });
    }
});
</script>

{% endblock %}

{% extends "base.html" %}
{% block content %}

<div class="my-5 bg-white p-4 rounded shadow-sm">
  <hr class="my-4">
  <div class="bg-light p-4 rounded shadow">
    <h5>Need Help With Inspection or Delivery?</h5>
    <p>
      Find agents or logistics providers around
      <strong>{{ product.state }}{% if product.city %}, {{ product.city }}{% endif %}</strong>.
    </p>

    <div class="d-flex gap-2 mb-3">
      <button id="findAgentBtn" class="btn btn-outline-primary btn-sm">Find Nearby Agents</button>
      <button id="findLogisticsBtn" class="btn btn-outline-success btn-sm">Find Nearby Logistics</button>
    </div>

    <div id="nearbyResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
      <!-- Cards and modals rendered here -->
    </div>
  </div>
</div>

<!-- ✅ Booking Success Modal -->
<div class="modal fade" id="bookingSuccessModal" tabindex="-1" aria-labelledby="bookingSuccessModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100" id="bookingSuccessModalLabel">Booking Confirmed ✅</h5>
      </div>
      <div class="modal-body">
        <p class="mb-0">Your booking request has been successfully sent.</p>
      </div>
    </div>
  </div>
</div>

<!-- ✅ JS Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const productId = {{ product.id }};
  const productTitle = {{ product.title | tojson }};
  const resultsDiv = document.getElementById('nearbyResults');

  function capitalizeWords(str) {
    return (str || '').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  function createWhatsAppLink(phone) {
    if (!phone) return '#';
    const cleanPhone = phone.replace(/\s+/g, '');
    return `https://wa.me/${cleanPhone.startsWith('0') ? '234' + cleanPhone.slice(1) : cleanPhone}`;
  }

  function handleBookingFormSubmit(event, modalId) {
    event.preventDefault();
    const form = event.target;

    fetch(form.action, {
      method: 'POST',
      body: new FormData(form)
    })
    .then(res => {
      if (res.ok) {
        const bookingModal = bootstrap.Modal.getInstance(document.getElementById(modalId));
        if (bookingModal) bookingModal.hide();

        const successModal = new bootstrap.Modal(document.getElementById('bookingSuccessModal'));
        successModal.show();
      } else {
        alert('Failed to book. Please try again.');
      }
    })
    .catch(err => {
      console.error(err);
      alert('An error occurred during booking.');
    });
  }

  function renderResults(role, data) {
    resultsDiv.innerHTML = '';

    if (!data || data.length === 0) {
      resultsDiv.innerHTML = `<div class="col-12">
        <div class="alert alert-warning">No nearby ${role}s found.</div>
      </div>`;
      return;
    }

    const roleLabel = role === 'logistics' ? 'Driver' : capitalizeWords(role);

    data.forEach(user => {
      const fullName = capitalizeWords(user.name || 'Unnamed');
      const city = capitalizeWords(user.city);
      const state = capitalizeWords(user.state);
      const phone = user.phone || '';
      const distance = parseFloat(user.distance_km || 0).toFixed(1);
      const hours = (distance / 60).toFixed(1);
      const isOnline = user.is_online;
      const onlineBadge = isOnline ? 'bg-success' : 'bg-secondary';
      const rating = user.avg_rating || 0;
      const reviews = user.review_count || 0;
      const whatsappLink = createWhatsAppLink(phone);
      const bookUrl = `/${role === 'logistics' ? 'logistics' : 'agents'}/book-${role}/${user.id}/${productId}`;
      const modalId = `bookingModal${role}${user.id}`;

      // Modal form fields — role-specific
      let additionalFields = '';
      if (role === 'logistics') {
        additionalFields = `
          <div class="mb-3">
            <label class="form-label">Sender Name</label>
            <input type="text" name="sender_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Pickup Address</label>
            <input type="text" name="pickup_address" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Address</label>
            <input type="text" name="delivery_address" class="form-control" required>
          </div>
        `;
      }

      const card = `
<div class="col">
  <div class="card h-100 border-0 shadow-sm">
    <div class="card-body p-3">
      <h6 class="fw-bold mb-1">${fullName}</h6>
      <p class="mb-1 text-muted small">${city}, ${state}</p>
      <p class="mb-1 small">${distance} km away (~${hours} hrs drive)</p>
      <span class="badge ${onlineBadge} mb-2">${isOnline ? 'Online' : 'Offline'}</span>
      <p class="small mb-1">Rating: <strong>${rating}★</strong> (${reviews} reviews)</p>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <a href="/chat/chat/${user.id}" class="btn btn-sm btn-outline-info">Chat</a>
        <a href="${whatsappLink}" class="btn btn-sm btn-outline-success" target="_blank">WhatsApp</a>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#${modalId}">
          Book ${roleLabel}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ Booking Modal -->
<div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="${bookUrl}" onsubmit="handleBookingFormSubmit(event, '${modalId}')">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Book ${fullName} for "<span class="text-primary">${productTitle}</span>"</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      ${additionalFields}

      <!-- Hidden Product ID -->
      <input type="hidden" name="product_id" value="${productId}">

      <!-- Booking Date -->
      <div class="mb-3">
        <label class="form-label">Booking Date</label>
        <input type="date" name="date" class="form-control" required>
      </div>

      <!-- Message -->
      <div class="mb-3">
        <label class="form-label">Message</label>
        <textarea name="message" class="form-control" rows="3" required></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="submit" class="btn btn-primary">Confirm</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
    </div>
  </div>
</form>

  </div>
</div>
      `;

      resultsDiv.insertAdjacentHTML('beforeend', card);
    });
  }

  function fetchNearby(role) {
    resultsDiv.innerHTML = `<div class="col"><div class="alert alert-info">Searching for nearby ${role}s...</div></div>`;

    if (!navigator.geolocation) {
      resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Geolocation not supported.</div></div>`;
      return;
    }

    navigator.geolocation.getCurrentPosition(position => {
      const { latitude, longitude } = position.coords;
      const routePath = role === 'logistics' ? 'logistics' : `${role}s`;

      fetch(`/agents/search-live-${routePath}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': "{{ csrf_token() }}"
        },
        body: JSON.stringify({ latitude, longitude })
      })
      .then(res => res.json())
      .then(data => renderResults(role, data))
      .catch(() => {
        resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Failed to load nearby ${role}s.</div></div>`;
      });
    }, () => {
      resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Location access denied.</div></div>`;
    });
  }

  document.getElementById('findAgentBtn').addEventListener('click', () => fetchNearby('agent'));
  document.getElementById('findLogisticsBtn').addEventListener('click', () => fetchNearby('logistics'));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

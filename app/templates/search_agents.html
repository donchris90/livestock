{% extends "base.html" %}
{% block content %}

<div class="my-5 bg-white p-4 rounded shadow-sm">
  <hr class="my-4">
  <div class="bg-light p-4 rounded shadow">
    <h5>Need Help With Inspection or Delivery?</h5>
    <p>
      Find agents or logistics providers around
      <strong>{{ product.state }}{% if product.city %}, {{ product.city }}{% endif %}</strong>.
    </p>

    <div class="d-flex gap-2 mb-3">
      <button id="findAgentBtn" class="btn btn-outline-primary btn-sm">Find Nearby Agents</button>
      <button id="findLogisticsBtn" class="btn btn-outline-success btn-sm">Find Nearby Logistics</button>
    </div>

    <div id="nearbyResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
  </div>
</div>

<!-- Booking Success Modal -->
<div class="modal fade" id="bookingSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100">Booking Confirmed ✅</h5>
      </div>
      <div class="modal-body">
        <p class="mb-0">Your booking request has been successfully sent.</p>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="profileContent">
        <p class="text-muted">Loading profile...</p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const productId = {{ product.id }};
  const productTitle = {{ product.title | tojson }};
  const resultsDiv = document.getElementById('nearbyResults');
  let refreshInterval;

  const capitalize = str => (str || '').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  const createWhatsAppLink = phone => phone ? `https://wa.me/${phone.replace(/^0/, '234').replace(/\s+/g,'')}` : '#';

  const showBookingSuccess = () => new bootstrap.Modal(document.getElementById('bookingSuccessModal')).show();

  const handleBooking = (event, modalId) => {
    event.preventDefault();
    const bookingModal = bootstrap.Modal.getInstance(document.getElementById(modalId));
    fetch(event.target.action, { method: 'POST', body: new FormData(event.target) })
      .then(res => {
        if(res.ok){
          if(bookingModal) bookingModal.hide();
          showBookingSuccess();
        } else alert('Failed to book. Please try again.');
      })
      .catch(err => { console.error(err); alert('Error during booking.'); });
  };

  const renderResults = (role, users) => {
    resultsDiv.innerHTML = '';
    if (!users?.length) {
      resultsDiv.innerHTML = `<div class="col-12"><div class="alert alert-warning">No nearby ${role}s found.</div></div>`;
      return;
    }

    users.forEach(user => {
      const fullName = capitalize(user.name || 'Unnamed');
      const city = capitalize(user.city || '');
      const state = capitalize(user.state || '');
      const phone = user.phone || '';
      const distance = parseFloat(user.distance_km || 0).toFixed(1);
      const hours = (distance / 60).toFixed(1);
      const isOnline = user.is_online;
      // Determine if user is verified
      const verified = (
    (user.kyc_status && user.kyc_status.toLowerCase() === 'approved') || // agents
    (user.kyc && user.kyc.status && user.kyc.status.toLowerCase() === 'approved') // logistics
);


      const modalId = `bookingModal${role}${user.id}`;

      const card = `
<div class="col">
  <div class="card h-100 border-0 shadow-sm ${verified ? '' : 'opacity-75'}">
    <div class="card-body p-3">
      <h6 class="fw-bold mb-1">${fullName}
        <span class="badge ${verified ? 'bg-success' : 'bg-secondary'} ms-1"
              data-bs-toggle="tooltip"
              title="${verified ? 'Verified (KYC approved)' : 'Unverified'}">
          ${verified ? '✔ Verified' : 'Unverified'}
        </span>
      </h6>
      <p class="mb-1 text-muted small">${city}, ${state}</p>
      <p class="mb-1 small">${distance} km away (~${hours} hrs drive)</p>
      <span class="badge ${isOnline ? 'bg-success' : 'bg-secondary'} mb-2">${isOnline ? 'Online' : 'Offline'}</span>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <a href="/chat/chat/${user.id}" class="btn btn-sm btn-outline-info">Chat</a>
        <a href="${createWhatsAppLink(phone)}" target="_blank" class="btn btn-sm btn-outline-success">WhatsApp</a>
        <button class="btn btn-sm btn-outline-secondary view-profile" data-role="${role}" data-user-id="${user.id}">View Profile</button>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#${modalId}">Book ${role==='logistics'?'Driver':capitalize(role)}</button>
      </div>
    </div>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <form method="POST" action="/${role==='logistics'?'logistics':'agents'}/book-${role}/${user.id}/${productId}" onsubmit="handleBooking(event,'${modalId}')">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Book ${fullName} for "<span class="text-primary">${productTitle}</span>"</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          ${role==='logistics'?`
            <div class="mb-3"><label class="form-label">Sender Name</label><input type="text" name="sender_name" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">Pickup Address</label><input type="text" name="pickup_address" class="form-control" required></div>
            <div class="mb-3"><label class="form-label">Delivery Address</label><input type="text" name="delivery_address" class="form-control" required></div>
          `:''}
          <input type="hidden" name="product_id" value="${productId}">
          <div class="mb-3"><label class="form-label">Booking Date</label><input type="date" name="date" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Message</label><textarea name="message" class="form-control" rows="3" required></textarea></div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Confirm</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>`;

      resultsDiv.insertAdjacentHTML('beforeend', card);
    });

    // Profile modal AJAX
    document.querySelectorAll('.view-profile').forEach(btn => {
      btn.addEventListener('click', () => {
        const userId = btn.dataset.userId;
        const role = btn.dataset.role;
        const modalContent = document.getElementById('profileContent');
        modalContent.innerHTML = "<p class='text-muted'>Loading profile...</p>";

        const url = role==='logistics'
          ? `/logistics/logistic_profile_standalone/${userId}?modal=1`
          : `/agents/agent_profile_standalone/${userId}?modal=1`;

        fetch(url, { headers: { 'X-Requested-With':'XMLHttpRequest' } })
          .then(res => res.text())
          .then(html => {
            modalContent.innerHTML = html;
            new bootstrap.Modal(document.getElementById('profileModal')).show();
          })
          .catch(err => { console.error(err); modalContent.innerHTML="<p class='text-danger'>Failed to load profile.</p>"; });
      });
    });

    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el=>new bootstrap.Tooltip(el));
  };

  const fetchNearby = role => {
    if (!navigator.geolocation) {
      resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Geolocation not supported.</div></div>`;
      return;
    }

    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      const route = role==='logistics'?'logistics':`${role}s`;

      fetch(`/agents/search-live-${route}`, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':"{{ csrf_token() }}"},
        body: JSON.stringify({ latitude, longitude })
      })
      .then(res=>res.json())
      .then(data=>renderResults(role,data))
      .catch(()=>resultsDiv.innerHTML=`<div class="col"><div class="alert alert-danger">Failed to load nearby ${role}s.</div></div>`);
    }, ()=> resultsDiv.innerHTML=`<div class="col"><div class="alert alert-danger">Location access denied.</div></div>`);
  };

  document.getElementById('findAgentBtn').addEventListener('click', ()=>{
    fetchNearby('agent');
    clearInterval(refreshInterval);
    refreshInterval = setInterval(()=>fetchNearby('agent'),30000);
  });

  document.getElementById('findLogisticsBtn').addEventListener('click', ()=>{
    fetchNearby('logistics');
    clearInterval(refreshInterval);
    refreshInterval = setInterval(()=>fetchNearby('logistics'),30000);
  });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

{% extends "base.html" %}
{% block content %}

<div class="my-5 bg-white p-4 rounded shadow-sm">
  <h5 class="mb-3">Need Help With Inspection or Delivery?</h5>
  <p class="mb-4">
    Find agents or logistics providers around
    <strong>{{ product.state }}{% if product.city %}, {{ product.city }}{% endif %}</strong>.
  </p>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6 d-grid">
      <button id="findAgentBtn" class="btn btn-outline-primary">Find Nearby Agents</button>
    </div>
    <div class="col-12 col-md-6 d-grid">
      <button id="findLogisticsBtn" class="btn btn-outline-success">Find Nearby Logistics</button>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6">
      <label for="manualAgent" class="form-label">Manual search for Agents:</label>
      <div class="input-group">
        <input type="text" id="manualAgent" class="form-control" placeholder="Enter city or state">
        <button id="manualAgentBtn" class="btn btn-primary">Search</button>
      </div>
    </div>
    <div class="col-12 col-md-6">
      <label for="manualLogistics" class="form-label">Manual search for Logistics:</label>
      <div class="input-group">
        <input type="text" id="manualLogistics" class="form-control" placeholder="Enter city or state">
        <button id="manualLogisticsBtn" class="btn btn-success">Search</button>
      </div>
    </div>
  </div>


  <hr class="my-4">

  <!-- Results grid -->
  <div id="nearbyResults" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"></div>
</div>



<!-- Booking Success Modal -->
<div class="modal fade" id="bookingSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100">Booking Confirmed ✅</h5>
      </div>
      <div class="modal-body">
        <p class="mb-0">Your booking request has been successfully sent.</p>
      </div>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="profileContent">
        <p class="text-muted">Loading profile...</p>
      </div>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const productId = {{ product.id }};
  const resultsDiv = document.getElementById('nearbyResults');

  const capitalize = str => (str || '').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  const createWhatsAppLink = phone => phone ? `https://wa.me/${phone.replace(/^0/, '234').replace(/\s+/g,'')}` : '#';

  // Render results
  const renderResults = (role, users) => {
    resultsDiv.innerHTML = '';
    if (!users?.length) {
      resultsDiv.innerHTML = `<div class="col-12"><div class="alert alert-warning">No nearby ${role}s found.</div></div>`;
      return;
    }

    // Sort: online first, verified, closer distance
    users.sort((a,b) => {
      const onlineA = a.is_online ? 1 : 0;
      const onlineB = b.is_online ? 1 : 0;
      if(onlineA !== onlineB) return onlineB - onlineA;

      const verifiedA = (
        (a.kyc_status && a.kyc_status.toLowerCase() === 'approved') ||
        (a.kyc && a.kyc.status && a.kyc.status.toLowerCase() === 'approved')
      ) ? 1 : 0;
      const verifiedB = (
        (b.kyc_status && b.kyc_status.toLowerCase() === 'approved') ||
        (b.kyc && b.kyc.status && b.kyc.status.toLowerCase() === 'approved')
      ) ? 1 : 0;
      if(verifiedA !== verifiedB) return verifiedB - verifiedA;

      return (a.distance_km ?? 999) - (b.distance_km ?? 999);
    });

    users.forEach(user => {
      const fullName = capitalize(user.name || 'Unnamed');
      const city = capitalize(user.city || '');
      const state = capitalize(user.state || '');
      const phone = user.phone || '';
      const distance = user.distance_km ? parseFloat(user.distance_km).toFixed(1) : 'N/A';
      const hours = user.distance_km ? (distance/60).toFixed(1) : 'N/A';
      const isOnline = user.is_online;
      const verified = (
        (user.kyc_status && user.kyc_status.toLowerCase() === 'approved') ||
        (user.kyc && user.kyc.status && user.kyc.status.toLowerCase() === 'approved')
      );

      const bookingUrl = role === 'logistics'
        ? `/logistics/book-logistics/${user.id}/${productId}`
        : `/agents/book-agent/${user.id}/${productId}`;

      const card = `
      <div class="col">
        <div class="card h-100 border-0 shadow-sm ${verified ? '' : 'opacity-75'}">
          <div class="card-body p-3">
            <h6 class="fw-bold mb-1">${fullName}
              <span class="badge ${verified ? 'bg-success' : 'bg-secondary'} ms-1"
                    data-bs-toggle="tooltip"
                    title="${verified ? 'Verified (KYC approved)' : 'Unverified'}">
                ${verified ? '✔ Verified' : 'Unverified'}
              </span>
            </h6>
            <p class="mb-1 text-muted small">${city}, ${state}</p>
            <p class="mb-1 small">Distance: ${distance} km (~${hours} hrs drive)</p>
            <span class="badge ${isOnline ? 'bg-success' : 'bg-secondary'} mb-2">${isOnline ? 'Online' : 'Offline'}</span>
            <div class="d-flex flex-wrap gap-2 mt-2">
              <a href="/chat/chat/${user.id}" class="btn btn-sm btn-outline-info">Chat</a>
              <a href="${createWhatsAppLink(phone)}" target="_blank" class="btn btn-sm btn-outline-success">WhatsApp</a>
              <button class="btn btn-sm btn-outline-secondary view-profile" data-role="${role}" data-user-id="${user.id}">View Profile</button>
              <a href="${bookingUrl}" class="btn btn-sm btn-primary">Book ${role === 'logistics' ? 'Driver' : capitalize(role)}</a>
            </div>
          </div>
        </div>
      </div>`;

      resultsDiv.insertAdjacentHTML('beforeend', card);
    });

    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));

    document.querySelectorAll('.view-profile').forEach(btn => {
      btn.addEventListener('click', () => {
        const userId = btn.dataset.userId;
        const role = btn.dataset.role;
        const modalContent = document.getElementById('profileContent');
        modalContent.innerHTML = "<p class='text-muted'>Loading profile...</p>";

        const url = role === 'logistics'
          ? `/logistics/logistic_profile_standalone/${userId}?modal=1`
          : `/agents/agent_profile_standalone/${userId}?modal=1`;

        fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(res => res.text())
          .then(html => {
            modalContent.innerHTML = html;
            new bootstrap.Modal(document.getElementById('profileModal')).show();
          })
          .catch(err => {
            console.error(err);
            modalContent.innerHTML = "<p class='text-danger'>Failed to load profile.</p>";
          });
      });
    });
  };

  // Automatic search via geolocation
  const fetchNearby = (role) => {
    const route = role === 'logistics' ? 'logistics' : 'agents';
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        fetch(`/agents/search-live-${route}`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
          body: JSON.stringify({ latitude, longitude })
        })
        .then(res => res.json())
        .then(data => renderResults(role, data))
        .catch(() => resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Failed to load nearby ${role}s.</div></div>`);
      }, () => {}); // user denied location
    }
  };

  // Manual search by city/state
  const manualSearch = (role) => {
    const inputId = role==='agent' ? 'manualAgent' : 'manualLogistics';
    const cityState = document.getElementById(inputId).value.trim();
    if(!cityState) return alert("Enter city or state to search");

    const route = role==='agent' ? 'agents' : 'logistics';
    fetch(`/agents/search-live-${route}`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
      body: JSON.stringify({ city: cityState.toLowerCase() })
    })
    .then(res => res.json())
    .then(data => renderResults(role, data))
    .catch(() => resultsDiv.innerHTML = `<div class="col"><div class="alert alert-danger">Failed to load ${role}s.</div></div>`);
  };

  // Attach button events
  ['agent','logistics'].forEach(role => {
    const btnGeo = document.getElementById(`find${capitalize(role)}Btn`);
    if(btnGeo) btnGeo.addEventListener('click', () => fetchNearby(role));

    const btnManual = document.getElementById(`manual${capitalize(role)}Btn`);
    if(btnManual) btnManual.addEventListener('click', () => manualSearch(role));
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const resultsDiv = document.getElementById('nearbyResults');
  const manualInput = document.getElementById('manualLogistics');
  const manualBtn = document.getElementById('manualLogisticsBtn');

  const capitalize = str => (str || '').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  const createWhatsAppLink = phone => phone ? `https://wa.me/${phone.replace(/^0/, '234').replace(/\s+/g,'')}` : '#';

  const renderLogisticsResults = (users) => {
    resultsDiv.innerHTML = '';
    if (!users?.length) {
      resultsDiv.innerHTML = `<div class="col-12"><div class="alert alert-warning">No logistics found.</div></div>`;
      return;
    }

    users.forEach(user => {
      const fullName = capitalize(user.name || 'Unnamed');
      const city = capitalize(user.city || '');
      const state = capitalize(user.state || '');
      const phone = user.phone || '';
      const isOnline = user.is_online;

      const bookingUrl = `/logistics/book-logistics/${user.id}/{{ product.id }}`;
      const chatUrl = `/chat/chat/${user.id}`;

      const card = `
      <div class="col">
        <div class="card h-100 border-0 shadow-sm">
          <div class="card-body p-3">
            <h6 class="fw-bold mb-1">${fullName} <small class="text-muted">(Driver)</small></h6>
            <p class="mb-1 text-muted small">${city}, ${state}</p>
            <span class="badge ${isOnline ? 'bg-success' : 'bg-secondary'} mb-2">${isOnline ? 'Online' : 'Offline'}</span>
            <div class="d-flex flex-wrap gap-2 mt-2">
              <a href="${chatUrl}" class="btn btn-sm btn-outline-info">Chat</a>
              <a href="${createWhatsAppLink(phone)}" target="_blank" class="btn btn-sm btn-outline-success">WhatsApp</a>
              <button class="btn btn-sm btn-outline-secondary view-profile" data-user-id="${user.id}">View Profile</button>
              <a href="${bookingUrl}" class="btn btn-sm btn-primary">Book Driver</a>
            </div>
          </div>
        </div>
      </div>`;

      resultsDiv.insertAdjacentHTML('beforeend', card);
    });

    // Profile modal handling
    document.querySelectorAll('.view-profile').forEach(btn => {
      btn.addEventListener('click', () => {
        const userId = btn.dataset.userId;
        const modalContent = document.getElementById('profileContent');
        modalContent.innerHTML = "<p class='text-muted'>Loading profile...</p>";

        fetch(`/logistics/logistic_profile_standalone/${userId}?modal=1`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(res => res.text())
          .then(html => {
            modalContent.innerHTML = html;
            new bootstrap.Modal(document.getElementById('profileModal')).show();
          })
          .catch(() => modalContent.innerHTML = "<p class='text-danger'>Failed to load profile.</p>");
      });
    });
  };

  const searchLogistics = () => {
    const query = manualInput.value.trim();
    if (!query) return alert("Enter city or state to search");

    fetch('/logistics/search-live-logistics', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': "{{ csrf_token() }}"
      },
      body: JSON.stringify({ city: query.toLowerCase() })
    })
    .then(res => {
      if(!res.ok) throw new Error('Network response was not ok');
      return res.json();
    })
    .then(data => renderLogisticsResults(data))
    .catch(err => {
      console.error(err);
      resultsDiv.innerHTML = `<div class="col-12"><div class="alert alert-danger">Failed to load logistics.</div></div>`;
    });
  };

  manualBtn.addEventListener('click', searchLogistics);
  manualInput.addEventListener('keyup', e => { if (e.key === 'Enter') searchLogistics(); });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>{{ product.title }} | Afrik Livestock Marketplace</title>
  <meta name="description" content="{{ product.description | truncate(160, True, '...') }}">
  <meta name="keywords" content="{{ product.category }}, {{ product.type }}, {{ product.city }}, {{ product.state }}, livestock, Afrik Livestock, {{ product.title }}">
  <link rel="canonical" href="{{ request.url }}">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="product">
  <meta property="og:title" content="{{ product.title }} | Afrik Livestock Marketplace">
  <meta property="og:description" content="{{ product.description | truncate(160, True, '...') }}">
  <meta property="og:image" content="{% if product.photos %}{{ product.photos[0] | replace('/upload/', '/upload/f_auto,q_auto,w_1200/') }}{% else %}https://res.cloudinary.com/your-cloud-name/image/upload/f_auto,q_auto,w_1200/v1690000000/seo/default.jpg{% endif %}">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:site_name" content="Afrik Livestock Marketplace">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ product.title }} | Afrik Livestock Marketplace">
  <meta name="twitter:description" content="{{ product.description | truncate(160, True, '...') }}">
  <meta name="twitter:image" content="{% if product.photos %}{{ product.photos[0] | replace('/upload/', '/upload/f_auto,q_auto,w_1200/') }}{% else %}https://res.cloudinary.com/your-cloud-name/image/upload/f_auto,q_auto,w_1200/v1690000000/seo/default.jpg{% endif %}">

  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { background-color: #f8f9fa; }
    .product-img, .carousel-inner img { width: 100%; max-height: 450px; object-fit: cover; border-radius: 0.75rem; }
    .card-img-top { height: 200px; object-fit: cover; }
    .price { font-size: 1.5rem; font-weight: bold; color: #198754; }
    .badge-verified { background-color: #198754; font-size: 0.75rem; color: white; padding: 0.25em 0.4em; border-radius: 0.25rem; }
    .product-card:hover { transform: scale(1.03); transition: transform 0.2s ease-in-out; }
    .review-stars { font-size: 0.9rem; }
  </style>

  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "BreadcrumbList",
        "itemListElement": [
          { "@type": "ListItem", "position": 1, "name": "Home", "item": "{{ url_for('main.home', _external=True) }}" },
          { "@type": "ListItem", "position": 2, "name": "{{ product.category }}", "item": "{{ url_for('main.home', q=product.category, _external=True) }}" },
          { "@type": "ListItem", "position": 3, "name": "{{ product.title }}", "item": "{{ request.url }}" }
        ]
      },
      {
        "@type": "Product",
        "name": "{{ product.title }}",
        "description": "{{ product.description | e }}",
        "image": [
          {% for photo in product.photos %}
            "{{ photo | replace('/upload/', '/upload/f_auto,q_auto,w_900/') }}"{% if not loop.last %},{% endif %}
          {% endfor %}
        ],
        "brand": { "@type": "Brand", "name": "Afrik Livestock" },
        "sku": "{{ product.id }}",
        "offers": {
          "@type": "Offer",
          "url": "{{ request.url }}",
          "priceCurrency": "NGN",
          "price": "{{ product.price }}",
          "priceValidUntil": "{{ price_valid_until }}",
          "availability": "https://schema.org/{% if product.quantity > 0 %}InStock{% else %}OutOfStock{% endif %}",
          "seller": { "@type": "Organization", "name": "{{ product.owner.first_name }} {{ product.owner.last_name }}" }
        },
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "{{ avg_rating_rounded if avg_rating_rounded else 0 }}",
          "reviewCount": "{{ total_reviews if total_reviews else 0 }}"
        },
        "review": [
          {% for review in reviews %}
          {
            "@type": "Review",
            "author": { "@type": "Person", "name": "{{ review.reviewer.first_name }} {{ review.reviewer.last_name }}" },
            "datePublished": "{{ review.created_at.strftime('%Y-%m-%d') if review.created_at else '' }}",
            "reviewBody": "{{ review.comment | e }}",
            "reviewRating": { "@type": "Rating", "ratingValue": "{{ review.rating }}", "bestRating": "5", "worstRating": "1" }
          }{% if not loop.last %},{% endif %}
          {% endfor %}
        ]
      },
      {
        "@type": "FAQPage",
        "mainEntity": [
          {
            "@type": "Question",
            "name": "How to buy {{ product.title }}?",
            "acceptedAnswer": { "@type": "Answer", "text": "You can contact the seller via WhatsApp or Chat, or use the Escrow system to secure your purchase." }
          },
          {
            "@type": "Question",
            "name": "Can I negotiate the price?",
            "acceptedAnswer": { "@type": "Answer", "text": "Yes, check the 'Negotiation' field on the product page and contact the seller." }
          }
        ]
      },
      {
        "@type": "LocalBusiness",
        "name": "{{ product.owner.company_name or (product.owner.first_name ~ ' ' ~ product.owner.last_name) }}",
        "image": "{{ product.owner.profile_photo if product.owner.profile_photo else url_for('static', filename='default_profile.png', _external=True) }}",
        "description": "{{ product.owner.about | e if product.owner.about else 'Trusted seller on Afrik Livestock marketplace.' }}",
        "address": {
          "@type": "PostalAddress",
          "streetAddress": "{{ product.owner.street }}",
          "addressLocality": "{{ product.owner.city }}",
          "addressRegion": "{{ product.owner.state }}",
          "addressCountry": "Nigeria"
        },
        "telephone": "{{ product.owner.phone }}",
        "url": "{{ url_for('seller_dashboard.view_profile', user_id=product.owner.id, _external=True) }}",
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "{{ avg_rating_rounded if avg_rating_rounded else 0 }}",
          "reviewCount": "{{ total_reviews if total_reviews else 0 }}"
        }
      }
    ]
  }
  </script>

  <style>
    body { background-color: #f8f9fa; }
    .product-img, .carousel-inner img { width: 100%; max-height: 450px; object-fit: cover; border-radius: 0.75rem; }
    .card-img-top { height: 200px; object-fit: cover; }
    .price { font-size: 1.5rem; font-weight: bold; color: #198754; }
    .badge-verified { background-color: #198754; font-size: 0.75rem; color: white; padding: 0.25em 0.4em; border-radius: 0.25rem; }
    .product-card:hover { transform: scale(1.03); transition: transform 0.2s ease-in-out; }
    .review-stars { font-size: 0.9rem; }
  </style>
</head>

<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('main.home') }}"> <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Livestock Market" style="height:40px;">
   </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <form class="d-flex ms-3 my-2 my-lg-0" method="GET" action="{{ url_for('main.home') }}">
        <input class="form-control me-2" type="search" name="q" placeholder="Search products..." value="{{ request.args.get('q','') }}">
        <button class="btn btn-outline-success" type="submit">Search</button>
      </form>
      <ul class="navbar-nav ms-auto">
        {% if current_user.is_authenticated %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('seller_dashboard.my_dashboard') }}">My Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.login') }}">Sign In</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.register') }}">Register</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
  <div class="row">
    <!-- Left Column: Product Details + Reviews -->
    <div class="col-lg-8">

      <!-- Product Carousel or Single Image -->
{% if product.photos and product.photos|length > 1 %}
<div id="carousel" class="carousel slide mb-3" data-bs-ride="carousel">
  <div class="carousel-inner">
    {% for photo in product.photos %}
    <div class="carousel-item {% if loop.first %}active{% endif %}">
      <img
        src="{{ photo | replace('/upload/', '/upload/f_auto,q_auto,w_900/') }}"
        class="d-block w-100 product-img"
        alt="{{ product.title }} - {{ product.category }} in {{ product.city }}, {{ product.state }}">
    </div>
    {% endfor %}
  </div>
  <button class="carousel-control-prev" type="button" data-bs-target="#carousel" data-bs-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Previous</span>
  </button>
  <button class="carousel-control-next" type="button" data-bs-target="#carousel" data-bs-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="visually-hidden">Next</span>
  </button>
</div>

{% elif product.photos %}
  <!-- Single Image -->
  <img
    src="{{ product.photos[0] | replace('/upload/', '/upload/f_auto,q_auto,w_900/') }}"
    class="d-block w-100 product-img"
    alt="{{ product.title }} - {{ product.category }} in {{ product.city }}, {{ product.state }}">

{% else %}
  <!-- Fallback Image -->
  <img
    src="https://res.cloudinary.com/your-cloud-name/image/upload/f_auto,q_auto,w_900/v1690000000/seo/default.jpg"
    class="d-block w-100 product-img"
    alt="No image available - Afrik Livestock">
{% endif %}


      <!-- Action Buttons -->
      <div class="d-flex flex-column flex-sm-row gap-2 mb-4">
        <a href="{{ url_for('agents.search_agents', product_id=product.id) }}" class="btn btn-primary flex-fill">Find Nearby Agents</a>
        <a href="{{ url_for('escrow.escrow_offer', product_id=product.id) }}" class="btn btn-primary flex-fill">Start Escrow</a>
        {% if current_user.is_authenticated and current_user.id != product.user_id %}
          <a href="{{ url_for('escrow.create_order', product_id=product.id) }}" class="btn btn-success flex-fill">Create Order</a>
        {% endif %}
      </div>

      <!-- Product Info -->
      <div class="bg-white p-3 rounded shadow-sm mb-4">
        <p class="price">₦{{ "{:,.2f}".format(product.price) }}</p>
        <p><strong>Category:</strong> {{ product.category }}</p>
        <p><strong>Type:</strong> {{ product.type }}</p>
        <p><strong>Quantity:</strong> {{ product.quantity }}</p>
        <p><strong>Location:</strong>
          {% if product.street %}{{ product.street }}, {% endif %}
          {% if product.city %}{{ product.city }}, {% endif %}
          {% if product.state %}{{ product.state }}{% endif %}
        </p>
        <p><strong>Description:</strong><br>{{ product.description }}</p>
        <p><strong>Negotiation:</strong> {{ product.open_to_negotiation }}</p>
        <p><strong>Views:</strong> {{ product.views or 0 }}</p>
      </div>

      <!-- Reviews Section -->
      <div class="bg-white p-3 rounded shadow-sm mb-4">
        {% if current_user.is_authenticated and current_user.role in ['buyer','seller'] and nearby_agents %}
        <!-- Average Rating -->
        <div class="mb-3">
          <strong>Average Rating:</strong>
          <span class="text-warning review-stars">
            {% for i in range(1,6) %}
              {% if i <= avg_rating_rounded %}⭐{% else %}☆{% endif %}
            {% endfor %}
          </span>
          <span class="ms-2">{{ avg_rating_rounded }}/5 ({{ total_reviews }} review{% if total_reviews != 1 %}s{% endif %})</span>
        </div>
        {% endif %}

        <h5>Customer Reviews</h5>
        {% if reviews %}
          {% for review in reviews %}
          <div class="border p-2 mb-2 rounded">
            <strong>{{ review.reviewer.first_name }}</strong>
            <span class="text-warning review-stars">{% for i in range(review.rating) %}⭐{% endfor %}{% for i in range(5-review.rating) %}☆{% endfor %}</span>
            <p>{{ review.comment }}</p>
            <small class="text-muted">{{ review.created_at.strftime('%Y-%m-%d') if review.created_at else '' }}</small>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No reviews yet.</p>
        {% endif %}
      </div>
    </div>

    <!-- Right Column: Seller Info + Safety Tips -->
    <div class="col-lg-4">

      <!-- Seller Card -->
      <div class="bg-white p-4 rounded shadow-sm text-center mb-4">
        <img src="{% if seller.profile_photo %}{{ url_for('static', filename=seller.profile_photo.split('static/')[-1].replace('\\','/')) }}{% else %}{{ url_for('static','default.jpg') }}{% endif %}"
             class="rounded-circle border border-secondary mb-3" width="80" height="80" alt="Seller Avatar">
        <h5>{{ seller.first_name }} {{ seller.last_name }}</h5>
        {% if seller.company_name %}<p class="text-muted mb-2"><strong>{{ seller.company_name }}</strong></p>{% endif %}
        {% if seller.is_verified %}<span class="badge bg-success mb-3">✔ Verified</span>{% endif %}
        <p class="mb-1"><strong>Phone:</strong> {{ product.phone_display or seller.phone }}</p>
        <p class="mb-3" style="font-size:12px;"><strong>Last seen:</strong> {{ seller.last_seen.strftime('%b %d, %Y %I:%M %p') if seller.last_seen else 'N/A' }}</p>
        <a href="https://wa.me/{{ product.phone_display or seller.phone }}" class="btn btn-success w-100 mb-2" target="_blank">💬 WhatsApp</a>
        <a href="{{ url_for('chat.chat_with_user', receiver_id=seller.id) }}" class="btn btn-outline-primary w-100 mb-2">💬 Chat Seller</a>
        <form action="{{ url_for('seller_dashboard.report_product', product_id=product.id) }}" method="POST" class="mb-2">
          <button class="btn btn-outline-danger w-100" onclick="return confirm('Report this product?')">🚩 Report</button>
        </form>
        <form action="{{ url_for('seller_dashboard.add_to_wishlist', product_id=product.id) }}" method="POST">
          <button class="btn btn-outline-danger w-100">❤️ Save to Wishlist</button>
        </form>
      </div>

      <!-- Safety Tips -->
      <div class="bg-white p-3 rounded shadow-sm mb-4">
        <h6>Safety Tips</h6>
        <p style="font-size:13px;">💡 <strong>Meet Safely:</strong> Meet sellers in public places or hire an agent to inspect the product.</p>
        <p style="font-size:13px;">💡 <strong>Secure Payments:</strong> Use escrow for agreed payments; avoid paying upfront without confirmation.</p>
        <p style="font-size:13px;">💡 <strong>Inspect Goods:</strong> Check product condition before paying.</p>
        <p style="font-size:13px;">💡 <strong>Review Carefully:</strong> Only pay when satisfied and leave honest feedback.</p>
        <p style="font-size:13px;">💡 <strong>Use Logistics:</strong> Use trusted delivery services for shipping.</p>
      </div>

    </div>
  </div>

  <!-- Similar Products -->
  <hr class="my-5">
  <h4>Similar Products</h4>
  <div class="row">
    {% for similar in similar_products %}
    <div class="col-6 col-md-3 mb-4">
      <div class="card product-card h-100 shadow-sm">
        <img src="{% if similar.photos %}{{ similar.photos[0] | replace('/upload/', '/upload/f_auto,q_auto,w_400/') }}{% else %}https://res.cloudinary.com/your-cloud-name/image/upload/f_auto,q_auto,w_400/v1690000000/seo/default.jpg{% endif %}"
     class="card-img-top" alt="{{ similar.title }}">

        <div class="card-body d-flex flex-column">
          <h6 class="card-title">{{ similar.title }}</h6>
          <p class="price">₦{{ "{:,.2f}".format(similar.price) }}</p>
          <a href="{{ url_for('seller_dashboard.product_detail', product_id=similar.id) }}" class="btn btn-sm btn-outline-primary mt-auto">View</a>
        </div>
      </div>
    </div>
    {% else %}
      <p class="text-muted">No similar products found.</p>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

{% extends "logistics/base.html" %}
{% block content %}
<div class="container my-5">
    <h3>Upload Documents</h3>
    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        <div id="dropArea" class="border border-dashed p-4 text-center rounded mb-3">
            <p>Drag & drop files here or click to select</p>
            <input type="file" id="fileInput" name="documents" multiple style="display:none;">
        </div>
        <div id="preview" class="mb-3"></div>
        <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
    </form>

    {% if user.documents %}
    <h5 class="mt-4">Uploaded Documents</h5>
    <ul class="list-group">
        {% for doc in user.documents %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ url_for('static', filename=doc.split('static/')[-1]) }}" target="_blank">
                {% if doc.endswith('.pdf') %}
                ðŸ“„ {{ doc.split('/')[-1] }}
                {% else %}
                <img src="{{ url_for('static', filename=doc.split('static/')[-1]) }}" height="50">
                {{ doc.split('/')[-1] }}
                {% endif %}
            </a>
            <form method="POST" action="{{ url_for('agents.delete_document', index=loop.index0) }}">
                <button class="btn btn-sm btn-danger" type="submit">Delete</button>
            </form>
        </li>
        {% endfor %}
    </ul>
    {% endif %}
</div>

<script>
const dropArea = document.getElementById("dropArea");
const fileInput = document.getElementById("fileInput");
const preview = document.getElementById("preview");

// Highlight drop area
['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.add('bg-light');
  }, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, e => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.remove('bg-light');
  }, false);
});

// Handle drop
dropArea.addEventListener('drop', e => {
  const files = e.dataTransfer.files;
  handleFiles(files);
});

// Click to select files
dropArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => handleFiles(fileInput.files));

// Preview function
function handleFiles(files) {
  preview.innerHTML = '';
  for (const file of files) {
    const div = document.createElement('div');
    div.classList.add('mb-2');

    if (file.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.style.height = '80px';
      img.classList.add('me-2');
      div.appendChild(img);
    } else if (file.type === 'application/pdf') {
      div.textContent = "ðŸ“„ " + file.name;
    } else {
      div.textContent = file.name;
    }
    preview.appendChild(div);
  }
}
</script>

<style>
#dropArea {
    cursor: pointer;
    border: 2px dashed #6c757d;
    transition: background-color 0.2s;
}
#dropArea.bg-light {
    background-color: #e9ecef;
}
</style>
{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Livestock Marketplace</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/a2c7c9e14a.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    .product-card .badge {
      font-size: 0.75rem;
      padding: 0.35em 0.6em;
      border-radius: 0.5rem;
      font-weight: 600;
    }
    .badge-featured { background-color: gold; color: black; }
    .badge-boosted { background-color: #17a2b8; color: white; }
    .badge-verified { background-color: #28a745; color: white; }
    .price { font-weight: bold; color: #28a745; }
    .sidebar { background-color: #f8f9fa; padding: 20px; border-radius: 10px; }
    .product-card { transition: transform 0.2s ease-in-out; }
    .product-card:hover { transform: scale(1.03); }
    .product-img { height: 200px; object-fit: cover; }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="{{ url_for('main.home') }}">üêÑ Livestock Market</a>

    <!-- Mobile Search Form -->
    <form class="d-flex ms-3 d-lg-none" method="GET" action="{{ url_for('main.home') }}">
      <input class="form-control me-2" type="search" name="q" placeholder="Search all products..." value="{{ request.args.get('search', '') }}">
      <button class="btn btn-outline-success" type="submit">Search</button>
    </form>

    <!-- Mobile toggle button -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Nav Links -->
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav">
        {% if current_user.is_authenticated %}
          <li class="nav-item">
            {% if current_user.is_admin %}
              <a class="nav-link" href="{{ url_for('admin.admin_dashboard') }}">Admin Dashboard</a>
            {% else %}
              <a class="nav-link" href="{{ url_for(current_user.role ~ '.' ~ current_user.role ~ '_dashboard') }}">My Profile</a>
            {% endif %}
          </li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a></li>
        {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.login') }}">Sign In</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('auth.register') }}">Register</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- Main Content -->
<div class="container-fluid mt-4">
  <div class="row">

    <!-- Sidebar for Desktop -->
    <div class="col-md-3 d-none d-md-block">
      <div class="sidebar">
        {% include 'filters_form.html' %}
      </div>
    </div>

    <!-- Mobile Filter Dropdown -->
    <div class="col-12 d-md-none mb-3">
      <div class="dropdown">
        <button class="btn btn-primary w-100 dropdown-toggle" type="button" id="mobileFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
          Filter Products
        </button>
        <div class="dropdown-menu p-3 w-100" aria-labelledby="mobileFilterBtn" style="min-width: 100%">
          {% include 'filters_form.html' %}
        </div>
      </div>
    </div>

    <!-- Products -->
    <div class="col-md-9">
      <div class="row g-4">
        {% for product in products %}
          <div class="col-md-4 col-lg-3">
            <div class="card h-100 shadow-sm border-0 product-card rounded-4 position-relative">
              <div class="position-relative">
                {% if product.photos and product.photos[0] %}
                  <img src="{{ url_for('static', filename=product.photos[0].split('static/')[-1]) }}" class="card-img-top product-img rounded-top" alt="{{ product.title }}">
                {% else %}
                  <img src="{{ url_for('static', filename='default.jpg') }}" class="card-img-top product-img rounded-top" alt="No image">
                {% endif %}

                {% if product.is_featured and product.featured_expiry and product.featured_expiry > now %}
                  <div class="position-absolute top-0 end-0 bg-warning text-dark fw-bold px-2 py-1 rounded-bottom-start z-1" data-bs-toggle="tooltip" title="Featured Product">üåü</div>
                {% elif product.is_top and product.top_expiry and product.top_expiry > now %}
                  <div class="position-absolute top-0 end-0 bg-success text-white fw-bold px-2 py-1 rounded-bottom-start z-1" data-bs-toggle="tooltip" title="Top Product">üìå</div>
                {% elif product.is_boosted and product.boosted_expiry and product.boosted_expiry > now %}
                  <div class="position-absolute top-0 end-0 bg-info text-white fw-bold px-2 py-1 rounded-bottom-start z-1" data-bs-toggle="tooltip" title="Boosted for visibility">üöÄ</div>
                {% endif %}
              </div>

              <div class="card-body d-flex flex-column">
                <h6 class="fw-bold text-truncate">{{ product.title }}</h6>

                <small class="text-muted mb-1">
                  üìÖ {{ product.created_at.strftime('%b %d, %Y') }}<br>
                  üìç {{ product.state }}, {{ product.city }}
                </small>

                <p class="price mt-2 mb-1">‚Ç¶{{ "{:,.2f}".format(product.price) }}</p>
                <small class="text-muted">Negotiable: {{ product.open_to_negotiation|capitalize }}</small>

                {% if product.user %}
                  <small class="mt-2 text-muted">
                    üë§ {{ product.user.first_name }} {{ product.user.last_name }}
                    {% if product.user.is_verified %}
                      <i class="fas fa-check-circle text-success" data-bs-toggle="tooltip" title="Verified Seller"></i>
                    {% endif %}
                  </small>
                {% endif %}

                <div class="mt-auto d-flex flex-column gap-2 mt-3">
                  {% if product.phone_display %}
                    <a href="https://wa.me/{{ product.phone_display | replace('0', '234', 1) }}" target="_blank" class="btn btn-sm btn-success w-100">üí¨ WhatsApp Seller</a>
                  {% endif %}
                  <a href="tel:{{ product.phone_display }}" class="btn btn-sm btn-outline-success w-100">üìû Call Seller</a>
                  {% if product.user %}
                    <a href="{{ url_for('chat.chat_with_user', receiver_id=product.user.id) }}" class="btn btn-sm btn-outline-primary w-100">üí¨ Chat Seller</a>
                  {% endif %}
                  <a href="{{ url_for('seller_dashboard.product_detail', product_id=product.id) }}" class="btn btn-sm btn-dark w-100">üîç View Details</a>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="col-12">
            <div class="alert alert-warning text-center">No products found for selected filters.</div>
          </div>
        {% endfor %}
      </div>
    </div>

  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
</script>

<!-- Location Update Script -->
<script>
{% if current_user.is_authenticated and current_user.role in ['agent', 'vet', 'logistics'] %}
setInterval(() => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      fetch("/update-location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude
        })
      });
    });
  }
}, 30000);
{% endif %}

navigator.geolocation.getCurrentPosition(pos => {
  fetch('/update-location', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ latitude: pos.coords.latitude, longitude: pos.coords.longitude })
  }).then(res => {
    if(res.ok) console.log('üìç Location updated');
    else console.warn('‚ùå Failed to update location');
  });
});
</script>

<!-- LGA Script -->
<script>
const lgasByState = {
  "Abia": ["Aba North", "Aba South", "Arochukwu", "Bende", "Ikwuano", "Isiala Ngwa North", "Isiala Ngwa South", "Isuikwuato", "Obi Ngwa", "Ohafia", "Osisioma", "Ugwunagbo", "Ukwa East", "Ukwa West", "Umuahia North", "Umuahia South", "Umu Nneochi"],
  "Adamawa": ["Demsa", "Fufore", "Ganye", "Girei", "Gombi", "Guyuk", "Hong", "Jada", "Lamurde", "Madagali", "Maiha", "Mayo-Belwa", "Michika", "Mubi North", "Mubi South", "Numan", "Shelleng", "Song", "Toungo", "Yola North", "Yola South"],
  // ... continue all 36 states with LGAs ...
};

const stateSelect = document.getElementById("state");
const citySelect = document.getElementById("city");

stateSelect.addEventListener("change", function () {
  const selectedState = this.value;
  citySelect.innerHTML = '<option value="">--Select LGA--</option>';
  if (lgasByState[selectedState]) {
    lgasByState[selectedState].forEach(lga => {
      const option = document.createElement("option");
      option.value = lga;
      option.textContent = lga;
      citySelect.appendChild(option);
    });
  }
});

window.addEventListener("DOMContentLoaded", () => {
  const selectedState = "{{ request.args.get('state') }}";
  const selectedCity = "{{ request.args.get('city') }}";
  if (selectedState && lgasByState[selectedState]) {
    lgasByState[selectedState].forEach(lga => {
      const option = document.createElement("option");
      option.value = lga;
      option.textContent = lga;
      if (lga === selectedCity) option.selected = true;
      citySelect.appendChild(option);
    });
  }
});
</script>

</body>
</html>

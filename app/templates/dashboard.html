{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Greeting & Mini Profile -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>üëã Hello, {{ user.first_name }}!</h3>
      <small class="text-muted">Role: {{ user.role.title() }}</small>
    </div>
    <div class="text-end">
      <img src="{{ user.avatar_url or url_for('static', filename='img/avatar-default.png') }}"
           class="rounded-circle border" width="60" height="60" alt="Avatar">
    </div>
  </div>

  <div class="row g-4">
    <!-- Left Column: Account Summary & Transfer -->
    <div class="col-lg-6 col-md-12">

      <!-- Account Summary -->
      <div class="card shadow-sm p-3">
        <h5 class="mb-3 fw-bold">üí∞ Account Summary</h5>
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between">
            <span>Pending Escrow (Locked):</span>
            <strong>‚Ç¶{{ "{:,.2f}".format(buyer_locked_total or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Amount Paid in Escrow:</span>
            <strong>‚Ç¶{{ "{:,.2f}".format(paid_escrow_total or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Escrow Received (Locked):</span>
            <strong>‚Ç¶{{ "{:,.2f}".format(locked_escrow_total or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Released (Available):</span>
            <strong>‚Ç¶{{ "{:,.2f}".format(released_amount or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Withdrawn:</span>
            <strong>‚Ç¶{{ "{:,.2f}".format(withdrawn_amount or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>Wallet Balance:</span>
            <div>
              <strong id="wallet-balance">‚Ç¶{{ "{:,.2f}".format(balance or 0) }}</strong>
              <a href="{{ url_for('seller_dashboard.withdraw') }}" class="btn btn-sm btn-warning ms-2">Withdraw</a>
            </div>
          </li>
          <li class="list-group-item">
            <div class="input-group">
              <input type="number" id="topup-amount" class="form-control form-control-sm" placeholder="Top-up Amount" step="0.01" min="0">
              <button class="btn btn-primary btn-sm" onclick="startTopup(document.getElementById('topup-amount').value)">Top Up</button>
            </div>
          </li>
        </ul>
      </div>

      <!-- Transfer Funds -->
      <div class="card shadow-sm p-3 mt-4">
        <h5 class="mb-3 fw-bold text-success">üîÑ Transfer Funds</h5>
        <form id="transferForm" action="{{ url_for('seller_dashboard.transfer_funds') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-2">
            <label>Transfer To:</label>
            <select name="recipient_type" id="recipient_type" class="form-select form-select-sm" required>
              <option value="">Select Recipient Type</option>
              <option value="escrow_agent">Escrow (Agent)</option>
              <option value="escrow_logistics">Escrow (Logistics)</option>
              <option value="direct_seller">Direct Seller</option>
              <option value="direct_agent">Direct Agent</option>
              <option value="direct_logistics">Direct Logistics</option>
              <option value="direct_vet">Direct Vet</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Recipient:</label>
            <select name="recipient_id" id="recipient_id" class="form-select form-select-sm" required>
              <option value="">Select Recipient</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Amount (‚Ç¶)</label>
            <input type="number" step="0.01" name="amount" id="amount" class="form-control form-control-sm" required>
          </div>

          <div class="mb-2">
            <label>Total Amount (‚Ç¶)</label>
            <input type="text" id="total_amount" class="form-control form-control-sm" readonly>
          </div>

          <div id="balance-warning" class="text-danger mb-2" style="display:none;">Insufficient funds for this transfer!</div>

          <button type="submit" class="btn btn-success w-100 btn-sm">Send Money</button>
        </form>
      </div>

      <!-- Transfer Funds JS -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const recipientType = document.getElementById("recipient_type");
          const recipientSelect = document.getElementById("recipient_id");
          const amountInput = document.getElementById("amount");
          const totalInput = document.getElementById("total_amount");
          const balanceWarning = document.getElementById("balance-warning");

          const userBalance = parseFloat("{{ balance or 0 }}");

          function updateTotal() {
            let amount = parseFloat(amountInput.value) || 0;
            let type = recipientType.value;
            let total = amount;

            if (type === 'escrow_agent' || type === 'escrow_logistics') total = amount * 1.03;

            totalInput.value = total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            balanceWarning.style.display = total > userBalance ? 'block' : 'none';
          }

          amountInput.addEventListener('input', updateTotal);
          recipientType.addEventListener('change', updateTotal);

          recipientType.addEventListener("change", async function () {
            const type = this.value;
            recipientSelect.innerHTML = '<option value="">Loading...</option>';

            if (!type) {
              recipientSelect.innerHTML = '<option value="">Select Recipient</option>';
              return;
            }

            try {
              const response = await fetch(`/dashboard/get_recipients/${type}`);
              if (!response.ok) throw new Error("Failed to fetch recipients");
              const data = await response.json();

              recipientSelect.innerHTML = '<option value="">Select Recipient</option>';
              data.length === 0
                ? recipientSelect.innerHTML = '<option value="">No recipients found</option>'
                : data.forEach(r => {
                    const opt = document.createElement("option");
                    opt.value = r.id;
                    opt.textContent = r.name;
                    recipientSelect.appendChild(opt);
                  });
            } catch (err) {
              console.error("Error fetching recipients:", err);
              recipientSelect.innerHTML = '<option value="">Error loading recipients</option>';
            }
          });

          document.getElementById('transferForm').addEventListener('submit', function(e) {
            const total = parseFloat(totalInput.value.replace(/,/g, '')) || 0;
            if (total > userBalance) {
              e.preventDefault();
              alert("Insufficient funds including escrow fee!");
            }
          });
        });
      </script>

    </div>

    <!-- Right Column: Orders & Top Products -->
    <div class="col-lg-6 col-md-12">
      <div class="row g-3">
        <div class="col-6">
          <div class="card text-center shadow-sm p-2">
            <h6>Total Orders</h6>
            <strong>{{ total_orders }}</strong>
          </div>
        </div>
        <div class="col-6">
          <div class="card text-center shadow-sm p-2">
            <h6>Pending Orders</h6>
            <strong>{{ pending_orders }}</strong>
          </div>
        </div>
        <div class="col-6">
          <div class="card text-center shadow-sm p-2">
            <h6>Completed Orders</h6>
            <strong>{{ completed_orders }}</strong>
          </div>
        </div>
        <div class="col-6">
          <div class="card shadow-sm p-2">
            <h6 class="mb-1">Sales Progress</h6>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: {{ sales_progress }}%">
                {{ sales_progress }}%
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Products -->
      <div class="card mt-3 p-3 shadow-sm">
        <h5 class="mb-2 fw-bold">üèÜ Top-Selling Products</h5>
        <ul class="list-group list-group-flush">
          {% for product in top_products %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ product.title }}
            <span class="badge bg-success rounded-pill">Sold: {{ product.sales_count or 0 }}</span>
          </li>
          {% else %}
          <li class="list-group-item">No sales yet. Start promoting your products!</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Escrow Status -->
      <div class="card mt-4 p-4 shadow-sm">
        <h5 class="mb-2 fw-bold">üíµ Escrow Status (Agent & Logistics)</h5>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mt-3">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <div id="escrow-list">
          {% for escrow in service_escrows %}
<div class="card mb-2 p-2 {% if escrow.is_released %}bg-light text-muted{% endif %}" id="escrow-{{ escrow.id }}">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <strong>Provider:</strong> {{ escrow.provider.full_name }} <br>
            <strong>Type:</strong> {{ escrow.type|capitalize }}
        </div>
        <div class="text-end">
            <div class="released-amount">
                Released: ‚Ç¶{{ "{:,.2f}".format(escrow.partial_release_amount or 0) }}
            </div>
            <div class="pending-amount">
                Pending: ‚Ç¶{{ "{:,.2f}".format((escrow.total_amount or 0) - (escrow.partial_release_amount or 0)) }}
            </div>
            <div class="status">
                Status: {{ escrow.status.replace("_", " ").title() }}
            </div>

            {% if not escrow.is_released %}
            <form action="{{ url_for('seller_dashboard.release_escrow', escrow_id=escrow.id) }}" method="POST" class="mt-2 d-flex gap-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="d-flex flex-column flex-md-row align-items-stretch gap-2">
  <!-- Amount Input -->
  <input type="number"
         name="amount"
         min="0"
         step="0.01"
         max="{{ (escrow.total_amount or 0) - (escrow.partial_release_amount or 0) }}"
         class="form-control form-control-sm flex-grow-1"
         placeholder="Enter amount to release">

  <!-- Full Amount Button -->
  <button type="button"
          class="btn btn-secondary btn-sm flex-shrink-0"
          data-escrow-id="{{ escrow.id }}">
      Full Amount
  </button>

  <!-- Release Button -->
  <button type="submit"
          class="btn btn-success btn-sm flex-shrink-0">
      Release
  </button>
</div>

            </form>
            {% else %}
            <div class="mt-2 text-success">
                Fully released ‚úÖ
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}

        </div>
      </div>

    </div>
  </div>
</div>

<!-- Socket.IO for Real-Time Escrow Updates -->
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
<script>
var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

socket.on('connect', function() { console.log("Connected to Socket.IO"); });

socket.on('escrow_update', function(data) {
  const escrowCard = document.getElementById(`escrow-${data.escrow_id}`);
  if (escrowCard) {
    escrowCard.querySelector(".released-amount").innerText = `Released: ‚Ç¶${Number(data.released_amount).toLocaleString(undefined,{minimumFractionDigits:2})}`;
    escrowCard.querySelector(".pending-amount").innerText = `Pending: ‚Ç¶${Number(data.pending_amount).toLocaleString(undefined,{minimumFractionDigits:2})}`;
    escrowCard.querySelector(".status").innerText = `Status: ${data.status.replace("_"," ").replace(/\b\w/g, l => l.toUpperCase())}`;
  }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Full Amount button
    document.querySelectorAll('.use-full-amount').forEach(btn => {
        btn.addEventListener('click', function() {
            const escrowId = this.dataset.escrowId;
            const card = document.getElementById(`escrow-${escrowId}`);
            const input = card.querySelector('.release-amount');

            // Convert text to Decimal-safe number
            const pendingText = card.querySelector('.pending-amount').textContent.replace(/[^0-9.-]+/g,"");
            input.value = parseFloat(pendingText).toFixed(2);
        });
    });
});
</script>


<!-- Paystack Topup -->
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
function startTopup(amount) {
  if (!amount || amount <= 0) { alert("Enter a valid amount"); return; }
  let handler = PaystackPop.setup({
    key: "pk_live_fdf1dc85ceb7346d5b9cbd3ab52c42ceabeae0f8",
    email: "{{ user.email }}",
    amount: Math.round(amount * 100),
    metadata: { user_id: {{ user.id }} },
    callback: function(response) {
      fetch(`/verify-topup/${response.reference}`)
        .then(res => res.json())
        .then(data => {
          if (data.wallet_balance) {
            document.getElementById('wallet-balance').textContent = `‚Ç¶${Number(data.wallet_balance).toLocaleString(undefined,{minimumFractionDigits:2})}`;
          }
          if(data.message) alert(data.message);
        })
        .catch(err => { console.error(err); alert("Error verifying payment"); });
    },
    onClose: function() { alert("Transaction cancelled"); }
  });
  handler.openIframe();
}
</script>

{% endblock %}

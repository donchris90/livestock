{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Greeting & Mini Profile -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3>👋 Hello, {{ user.first_name }}!</h3>
      <small class="text-muted">Role: {{ user.role.title() }}</small>
    </div>
    <div class="text-end">
      <img src="{{ user.avatar_url or url_for('static', filename='img/avatar-default.png') }}"
           class="rounded-circle border" width="60" height="60" alt="Avatar">
    </div>
  </div>
<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const toastContainer = document.getElementById('toast-container');

  socket.on('featured_notification', (data) => {
    let bgClass = 'bg-success';
    if (data.status === 'expired') bgClass = 'bg-danger';
    else if (data.status === 'expiring_soon') bgClass = 'bg-warning';

    const toastEl = document.createElement('div');
    toastEl.className = 'toast';
    toastEl.role = 'alert';
    toastEl.dataset.bsAutohide = 'true';
    toastEl.dataset.bsDelay = '8000';

    toastEl.innerHTML = `
      <div class="toast-header ${bgClass} text-white">
        <strong class="me-auto">Featured Product Alert</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body">${data.message}</div>
    `;

    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    toastEl.addEventListener('hidden.bs.toast', () => {
      toastEl.remove();
    });
  });
</script>


<div class="container my-4">
  <h4 class="mb-3">Expiring / Expired Featured Products</h4>

  {% if expiring_products %}
    <div class="row g-3">
      {% for product in expiring_products %}
        {% set days_left = (product.featured_expiry - now).days %}
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">{{ product.title }}</h6>

              {% if product.featured_expiry < now %}
                <span class="badge bg-danger mb-2">Expired</span>
              {% else %}
                <span class="badge bg-warning mb-2">Expiring Soon</span>
              {% endif %}

              <!-- Progress bar showing urgency -->
              {% if product.featured_expiry >= now %}
                {% set progress = ((3 - days_left)/3 * 100) if days_left <= 3 else 0 %}
                <div class="progress mb-2" style="height: 8px;">
                  <div class="progress-bar bg-warning" role="progressbar" style="width: {{ progress }}%;"
                       aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              {% endif %}

              <small class="text-muted">
                Expiry: {{ product.featured_expiry.strftime('%d %b, %Y') }}
                {% if product.featured_expiry >= now and days_left <= 3 %}
                  ({{ days_left }} day{{ 's' if days_left != 1 else '' }} left)
                {% endif %}
              </small>

              <a href="{{ url_for('products.edit_product', product_id=product.id) }}"
                 class="btn btn-sm btn-primary mt-auto">Manage Product</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center text-muted">No expiring or expired featured products.</p>
  {% endif %}
</div>
  <div class="row g-4">
    <!-- Left Column: Account Summary & Transfer -->
    <div class="col-lg-6 col-md-12">

      <!-- Account Summary -->
      <div class="card shadow-sm p-3">
        <h5 class="mb-3 fw-bold">💰 Account Summary</h5>
        <ul class="list-group list-group-flush">
          <li class="list-group-item d-flex justify-content-between">
            <span>Pending Escrow (Locked):</span>
            <strong>₦{{ "{:,.2f}".format(buyer_locked_total or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Amount Paid in Escrow:</span>
            <strong>₦{{ "{:,.2f}".format(paid_escrow_total or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Escrow Received (Locked):</span>
            <strong>₦{{ "{:,.2f}".format(locked_escrow_total or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Released (Available):</span>
            <strong>₦{{ "{:,.2f}".format(released_amount or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <span>Withdrawn:</span>
            <strong>₦{{ "{:,.2f}".format(withdrawn_amount or 0) }}</strong>
          </li>
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>Wallet Balance:</span>
            <div>
              <strong id="wallet-balance">₦{{ "{:,.2f}".format(balance or 0) }}</strong>
              <a href="{{ url_for('seller_dashboard.withdraw') }}" class="btn btn-sm btn-warning ms-2">Withdraw</a>
            </div>
          </li>
          <li class="list-group-item">
            <div class="input-group">
              <input type="number" id="topup-amount" class="form-control form-control-sm" placeholder="Top-up Amount" step="0.01" min="0">
              <button class="btn btn-primary btn-sm" onclick="startTopup(document.getElementById('topup-amount').value)">Top Up</button>
            </div>
          </li>
        </ul>
      </div>

      <!-- Transfer Funds -->
      <div class="card shadow-sm p-3 mt-4">
        <h5 class="mb-3 fw-bold text-success">🔄 Transfer Funds</h5>
        <form id="transferForm" action="{{ url_for('seller_dashboard.transfer_funds') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="mb-2">
            <label>Transfer To:</label>
            <select name="recipient_type" id="recipient_type" class="form-select form-select-sm" required>
              <option value="">Select Recipient Type</option>
              <option value="escrow_agent">Escrow (Agent)</option>
              <option value="escrow_logistics">Escrow (Logistics)</option>
              <option value="direct_seller">Direct Seller</option>
              <option value="direct_agent">Direct Agent</option>
              <option value="direct_logistics">Direct Logistics</option>
              <option value="direct_vet">Direct Vet</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Recipient:</label>
            <select name="recipient_id" id="recipient_id" class="form-select form-select-sm" required>
              <option value="">Select Recipient</option>
            </select>
          </div>

          <div class="mb-2">
            <label>Amount (₦)</label>
            <input type="number" step="0.01" name="amount" id="amount" class="form-control form-control-sm" required>
          </div>

          <div class="mb-2">
            <label>Total Amount (₦)</label>
            <input type="text" id="total_amount" class="form-control form-control-sm" readonly>
          </div>

          <div id="balance-warning" class="text-danger mb-2" style="display:none;">Insufficient funds for this transfer!</div>

          <button type="submit" class="btn btn-success w-100 btn-sm">Send Money</button>
        </form>
      </div>

      <!-- Transfer Funds JS -->
   <script>
document.addEventListener("DOMContentLoaded", () => {
    const recipientType = document.getElementById("recipient_type");
    const recipientSelect = document.getElementById("recipient_id");
    const amountInput = document.getElementById("amount");
    const totalInput = document.getElementById("total_amount");
    const balanceWarning = document.getElementById("balance-warning");

    const userBalance = parseFloat("{{ balance or 0 }}") || 0;

    // Function to calculate total including escrow fee
    function updateTotal() {
        let amount = parseFloat(amountInput.value) || 0;
        let type = recipientType.value;
        let total = amount;

        // Add 3% escrow fee for escrow transfers
        if (type === 'escrow_agent' || type === 'escrow_logistics') {
            total = amount * 1.03;
        }

        totalInput.value = total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Show warning if total exceeds balance
        balanceWarning.style.display = total > userBalance ? 'block' : 'none';
    }

    // Event listeners for live calculation
    amountInput.addEventListener('input', updateTotal);
    recipientType.addEventListener('change', updateTotal);

    // Load recipients dynamically based on type
    recipientType.addEventListener("change", async function () {
        const type = this.value;
        recipientSelect.innerHTML = '<option value="">Loading...</option>';

        if (!type) {
            recipientSelect.innerHTML = '<option value="">Select Recipient</option>';
            return;
        }

        try {
            const response = await fetch(`/dashboard/get_recipients/${type}`);
            if (!response.ok) throw new Error("Failed to fetch recipients");
            const data = await response.json();

            recipientSelect.innerHTML = '<option value="">Select Recipient</option>';
            if (data.length === 0) {
                recipientSelect.innerHTML = '<option value="">No recipients found</option>';
            } else {
                data.forEach(r => {
                    const opt = document.createElement("option");
                    opt.value = r.id;
                    opt.textContent = r.name;
                    recipientSelect.appendChild(opt);
                });
            }
        } catch (err) {
            console.error("Error fetching recipients:", err);
            recipientSelect.innerHTML = '<option value="">Error loading recipients</option>';
        }
    });

    // Prevent submitting if balance is insufficient
    document.getElementById('transferForm').addEventListener('submit', function(e) {
        const total = parseFloat(totalInput.value.replace(/,/g, '')) || 0;
        if (total > userBalance) {
            e.preventDefault();
            alert("Insufficient funds including escrow fee!");
        }
    });
});
</script>



    </div>

    <!-- Right Column: Orders & Top Products -->
    <div class="col-lg-6 col-md-12">
      <div class="row g-3">
        <div class="col-6">
          <div class="card text-center shadow-sm p-2">
            <h6>Total Orders</h6>
            <strong>{{ total_orders }}</strong>
          </div>
        </div>
        <div class="col-6">
          <div class="card text-center shadow-sm p-2">
            <h6>Pending Orders</h6>
            <strong>{{ pending_orders }}</strong>
          </div>
        </div>
        <div class="col-6">
          <div class="card text-center shadow-sm p-2">
            <h6>Completed Orders</h6>
            <strong>{{ completed_orders }}</strong>
          </div>
        </div>
        <div class="col-6">
          <div class="card shadow-sm p-2">
            <h6 class="mb-1">Sales Progress</h6>
            <div class="progress" style="height: 20px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: {{ sales_progress }}%">
                {{ sales_progress }}%
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Products -->
      <div class="card mt-3 p-3 shadow-sm">
        <h5 class="mb-2 fw-bold">🏆 Top-Selling Products</h5>
        <ul class="list-group list-group-flush">
          {% for product in top_products %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ product.title }}
            <span class="badge bg-success rounded-pill">Sold: {{ product.sales_count or 0 }}</span>
          </li>
          {% else %}
          <li class="list-group-item">No sales yet. Start promoting your products!</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Escrow Status -->
      <div class="card mt-4 p-4 shadow-sm">
        <h5 class="mb-2 fw-bold">💵 Escrow Status (Agent & Logistics)</h5>



        <div id="escrow-list">
          {% for escrow in service_escrows %}
<div class="card mb-2 p-2 {% if escrow.is_released %}bg-light text-muted{% endif %}" id="escrow-{{ escrow.id }}">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <strong>Provider:</strong> {{ escrow.provider.full_name }} <br>
            <strong>Type:</strong> {{ escrow.type|capitalize }}
        </div>
        <div class="text-end">
            <div class="released-amount">
                Released: ₦{{ "{:,.2f}".format(escrow.partial_release_amount or 0) }}
            </div>
            <div class="pending-amount">
                Pending: ₦{{ "{:,.2f}".format((escrow.total_amount or 0) - (escrow.partial_release_amount or 0)) }}
            </div>
            <div class="status">
                Status: {{ escrow.status.replace("_", " ").title() }}
            </div>

            {% if not escrow.is_released %}
        <form action="{{ url_for('seller_dashboard.release_escrow', escrow_id=escrow.id) }}" method="POST" class="d-flex">
    <!-- Partial release input -->




    <!-- Full release button -->
    <button type="submit" name="full_release" value="1" class="btn btn-primary">
        Release
    </button>
</form>

            {% else %}
            <div class="mt-2 text-success">
                Fully released ✅
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endfor %}

        </div>
      </div>

    </div>
  </div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Full Amount buttons
    document.querySelectorAll('.use-full-amount').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();  // prevent default form submission

            const escrowId = this.dataset.escrowId;
            const card = document.getElementById(`escrow-${escrowId}`);
            if (!card) return;

            const input = card.querySelector('input[name="amount"]');  // safer selector
            const pendingDiv = card.querySelector('.pending-amount');
            if (!input || !pendingDiv) return;

            // Remove any non-numeric characters to safely parse
            const pendingText = pendingDiv.textContent.replace(/[^0-9.-]+/g,"");
            const pendingAmount = parseFloat(pendingText) || 0;

            input.value = pendingAmount.toFixed(2);
        });
    });
});
</script>

<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
window.startTopup = function(amount) {
    amount = parseFloat(amount);
    if (!amount || amount <= 0) {
        alert("Enter a valid top-up amount");
        return;
    }

    if (typeof PaystackPop === "undefined") {
        alert("Paystack script not loaded. Try refreshing the page.");
        return;
    }

    let handler = PaystackPop.setup({
        key: "pk_live_fdf1dc85ceb7346d5b9cbd3ab52c42ceabeae0f8",
        email: {{ user.email|tojson }},
        amount: Math.round(amount * 100),
        metadata: { user_id: {{ user.id|tojson }} },
        callback: function(response) {
            console.log("Paystack reference:", response.reference);

            fetch(`/verify-topup/${response.reference}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert("Top-up failed: " + data.error);
                    return;
                }

                // Update wallet balance on page
                if (data.wallet_balance !== undefined) {
                    document.getElementById('wallet-balance').textContent =
                        `₦${Number(data.wallet_balance).toLocaleString(undefined,{minimumFractionDigits:2})}`;
                }

                if (data.message) {
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error("Verification error:", err);
                alert("Error verifying payment. Check console for details.");
            });
        },
        onClose: function() {
            alert("Transaction cancelled");
        }
    });

    handler.openIframe();
}
</script>


{% endblock %}
